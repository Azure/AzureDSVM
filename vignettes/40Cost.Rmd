---
title = "Get data consumption for computation on Azure DSVMs"
author= "Graham Williams"
---

# Use Case

Many times data scientists care not merely the computation but also economy efficiency of running analytical jobs on cloud. It is therefore useful to have a monitor tool to obtain data consumption and total expense for using Azure DSVMs. This vignette will show how to achieve this with AzureDSR `consumptionCalculator` function.

# Setup

We assume that the first step of [ConnectToLinuxDSVM](https://github.com/Azure/AzureDSR/vignettes/ConnectToLinuxDSVM.Rmd) has been done, and there is at least one Linux DSVM existing at the created resouce group.

To begin with, let's check the status of the DSVM and start it if it is deallocated. This is achieved with AzureSMR, and again confidentials for authenticating the app in Active Directory should be provided.

```{r setup}
# Load the required subscription resources: TID, CID, and KEY.
# Also includes the ssh PUBKEY for the user.

USER <- Sys.getenv("USER")

source(paste0(USER, "_credentials.R"))
```

```{r credentials, eval=FALSE}
# Credentials come from app creation in Active Directory within Azure.
 
TID <- "72f9....db47"          # Tenant ID
CID <- "9c52....074a"          # Client ID
KEY <- "9Efb....4nwV....ASa8=" # User key
```

```{r packages}
# Load the required packages.

library(AzureSMR)    # Support for managing Azure resources.
library(AzureDSR)    # Further support for the Data Scientist.
library(magrittr)    
library(dplyr)
library(rattle)      # Use weatherAUS as a "large" dataset.
```

# Data consumption

Let's use the DSVM deployed in the previous tutorial chapters for this experiment. The basic information for getting the expense include

* Time period in which cost of the VM is evaluated. It is specified two separated parameters which are starting time and ending time. There are two data aggregation methods, "daily" based and "hourly" based, which calculate data consumption based on day and hour, respectively, as names suggest.
* Currency in which the cost is measured. For example, "USD".
* Locale where the expense is evaluated.
* Region where the instance located.
* Offer ID. Can be checked [here](https://azure.microsoft.com/en-us/support/legal/offer-details/).

```{r}
VM     <- "msvm001"
START  <- "2017-01-06 00:00:00"
END    <- "2017-01-10 00:00:00"
GRA    <- "Daily"

CURR   <- "USD"
LOCALE <- "en-SG"
REG    <- "SG"
OFFER  <- "MS-AZR-0015P"
```

Get data consumption of the virtual machine.
```{r}

# authentication with Azure account.

context <- createAzureContext(tenantID=TID, clientID=CID, authKey=KEY)

# get data consumption of instance.

data_consum <- dataConsumption(context,
                               instance=VM,
                               timeStart=START,
                               timeEnd=END,
                               granularity=GRA)

print(data_consum)
```

After that just simply call the function to get the expense of the instance. 

```{r}
consum <- expenseCalculator(context,
                            instance=VM,
                            timeStart=START,
                            timeEnd=END,
                            granularity=GRA,
                            currency=CURR,
                            locale=LOCALE,
                            offerId=OFFER,
                            region=REG)

print(consum)
```
